#%SED_GAWK_PATH%

# ------------------------------------------------------------
# cawk is subject to a MIT open-source licence
# please refer to the MIT licence file for further information
#
# for %SED_VAR% changes like GAWK_PATH, etc. please refer to
# file support/tests.sed for further information
#
# purpose : check if <loopback 127/8 rules> are set on lo to accept
#           and drop packets (pf)
# author  : quentin gavilan (pf adaptation)
# ------------------------------------------------------------

@include %SED_INCLUDE_PATH%

# Checks one complete pf rule line
function processrule(line) {
    # Detect "allow loopback" rule
    # Typical examples:
    #   pass quick on lo
    #   pass in on lo
    if (!lo_accept_found && line ~ /^pass[ \t]/ && line ~ /on[ \t]+lo/) {
        lo_accept_found = 1
        lo_accept_line = line
        lo_accept_lineno = FNR
    }

    # Detect drop/reject packets from 127.0.0.0/8 not coming from lo
    # Typical pf antispoof-style rule:
    #   block drop in quick on egress from 127.0.0.0/8 to any
    # or any equivalent rule that:
    #   - is a "block drop" rule
    #   - is "in quick"
    #   - matches source 127.0.0.0/8
    #   - is NOT on lo
    if (!spoof_drop_found && line ~ /^block[ \t]/ && line ~ /drop/ && line ~ /in[ \t]/ && line ~ /quick/ && line ~ /from[ \t]+127\.0\.0\.0\/8/ && line ~ /on[ \t]+[A-Za-z0-9_]+/ && line !~ /on[ \t]+lo([ \t]|$)/) {
        spoof_drop_found = 1
        spoof_drop_line = line
        spoof_drop_lineno = FNR
    }
}

BEGIN {
}

BEGINFILE {
    rule = ""
    lo_accept_found = 0
    spoof_drop_found = 0
    lo_accept_line = ""
    spoof_drop_line = ""
    lo_accept_lineno = 0
    spoof_drop_lineno = 0
}

# Handles a normal one-line pf rule
/^(pass|block)[ \t]/ && !/\\$/ {
    processrule($0)
    next
}

# Handles a multi line pf rule
/^(pass|block)[ \t]/ && /\\$/ && rule == "" {
    rule = rule $0
    next
}
/\\$/ && rule != "" {
    rule = rule $0
    next
}
!/\\$/ && rule != "" {
    rule = rule $0
    processrule(rule)
    rule = ""
    next
}

ENDFILE {
    if (lo_accept_found) {
        print_err("global_loopbackantispoof_set.packetfilter-fwcli.gawk","<loopback 127/8 rules> accept found <<" lo_accept_line ">> : ",lo_accept_lineno,"medium","pass")
    } else {
        print_err("global_loopbackantispoof_set.packetfilter-fwcli.gawk","<loopback 127/8 rules> accept missing (pass ... on lo ...)",FNR,"medium","error")
    }

    if (spoof_drop_found) {
        print_err("global_loopbackantispoof_set.packetfilter-fwcli.gawk","<loopback 127/8 rules> drop found <<" spoof_drop_line ">> : ",spoof_drop_lineno,"high","pass")
    } else {
        print_err("global_loopbackantispoof_set.packetfilter-fwcli.gawk","<loopback 127/8 rules> drop missing (block drop in quick on <if> from 127.0.0.0/8 ... , interface not lo)",FNR,"high","error")
    }
}

END {
}

